<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast - AquaWise</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="assets/aquawise_logo.png">
    <link rel="stylesheet" href="assets/professional-ui.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        :root {
            --primary: #0d6efd;
            --primary-dark: #0043a8;
            --secondary: #6c757d;
            --success: #198754;
            --info: #0dcaf0;
            --warning: #ffc107;
            --danger: #dc3545;
            --background-overlay: rgba(0, 0, 0, 0.4);
            --card-glass: rgba(255, 255, 255, 0.92);
            --text-main: #1a1a1a;
            --text-light: #666;
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364), url('assets/background.png') no-repeat center center/cover;
            background-attachment: fixed;
            min-height: 100vh;
            padding-bottom: 40px;
            color: var(--text-main);
            position: relative;
        }

        /* Overlay for readability */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(3px);
            z-index: -1;
        }

        /* Navigation Bar */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
        }

        .logo-img {
            height: 45px;
            width: auto;
        }

        .navbar-brand span {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            color: var(--text-main);
            font-size: 1.5rem;
            letter-spacing: -0.5px;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 5px 20px 5px 5px;
            background: #f2f2f0;
            border-radius: 50px;
            font-weight: 600;
            color: #333;
            border: none;
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #e7f1ff;
            color: var(--primary);
        }

        .nav-btn:hover {
            background: #cfe2ff;
            transform: translateY(-2px);
        }

        .logout-btn {
            background: #ffebeb;
            color: var(--danger);
        }

        .logout-btn:hover {
            background: #f8d7da;
        }

        /* Container & Header */
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
            background: var(--card-glass);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .page-header h1 {
            color: var(--primary-dark);
            margin-bottom: 10px;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .page-header p {
            font-size: 1.1em;
            color: var(--text-light);
        }

        .refresh-btn {
            margin-top: 15px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .refresh-btn:hover {
            background: var(--primary-dark);
            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);
            transform: translateY(-2px);
        }

        /* Weather Section Glassmorphism */
        .current-weather,
        .forecast-section,
        .irrigation-schedule,
        .irrigation-advice {
            background: var(--card-glass);
            padding: 30px;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease;
        }

        .current-weather:hover,
        .forecast-section:hover,
        .irrigation-schedule:hover,
        .irrigation-advice:hover {
            transform: translateY(-5px);
        }

        .current-weather {
            text-align: center;
        }

        h2 {
            color: var(--primary-dark);
            margin-bottom: 25px;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid rgba(13, 110, 253, 0.1);
            padding-bottom: 15px;
        }

        /* Current Weather Specifics */
        .location {
            font-size: 2em;
            font-weight: 800;
            margin-bottom: 5px;
            font-family: 'Outfit', sans-serif;
            color: var(--text-main);
        }

        .location-details {
            font-size: 0.9em;
            color: var(--text-light);
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .weather-icon {
            font-size: 5em;
            margin: 15px 0;
            color: var(--warning);
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .temperature {
            font-size: 4em;
            font-weight: 800;
            color: var(--primary);
            font-family: 'Outfit', sans-serif;
            margin-bottom: 10px;
        }

        .weather-description {
            font-size: 1.5em;
            text-transform: capitalize;
            color: #333;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .detail-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }

        .detail-box:hover {
            background: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
            border-color: rgba(13, 110, 253, 0.2);
        }

        .detail-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .detail-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }

        .detail-label {
            color: #444;
            font-size: 0.95em;
            font-weight: 600;
        }

        /* Water Savings Calculator */
        .water-savings {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
            text-align: center;
        }

        .water-savings h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .savings-value {
            font-size: 3.5em;
            font-weight: bold;
            margin: 20px 0;
        }

        .savings-text {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .forecast-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
        }

        .forecast-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .forecast-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .forecast-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .forecast-day {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .forecast-date {
            font-size: 0.85em;
            color: #555;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .forecast-icon {
            font-size: 3em;
            margin: 10px 0;
        }

        .forecast-temp {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
        }

        .forecast-desc {
            color: #444;
            font-size: 0.9em;
            margin-top: 5px;
            text-transform: capitalize;
            font-weight: 500;
        }

        .forecast-rain {
            margin-top: 8px;
            padding: 5px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* Irrigation Schedule */
        .irrigation-schedule {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
        }

        .irrigation-schedule h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .schedule-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.05);
            /* Base border */
            border-left-width: 5px;
            /* Restoration of left border */
        }

        .schedule-card.skip {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .schedule-card.caution {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .schedule-card.irrigate {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .schedule-day {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .schedule-action {
            font-size: 0.95em;
            margin-bottom: 8px;
        }

        .schedule-reason {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }

        .irrigation-advice {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(99, 102, 241, 0.95) 100%);
            backdrop-filter: blur(10px);
            color: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .irrigation-advice h2 {
            margin-bottom: 25px;
            font-size: 1.6em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .irrigation-advice h2 i {
            color: #FDE68A;
        }

        .advice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .advice-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid white;
        }

        .advice-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .advice-card p {
            font-size: 0.95em;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Alert Banner Styles - Premium Design */
        .alert-banner {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 20px;
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.6;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideInDown 0.5s ease-out;
            transition: all 0.3s ease;
        }

        .alert-banner:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
        }

        .alert-banner.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%);
            color: white;
            border-left: 5px solid #059669;
        }

        .alert-banner.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(220, 38, 38, 0.95) 100%);
            color: white;
            border-left: 5px solid #dc2626;
        }

        .alert-banner.warning {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.95) 0%, rgba(245, 158, 11, 0.95) 100%);
            color: #78350f;
            border-left: 5px solid #f59e0b;
        }

        .alert-banner strong {
            font-weight: 700;
            font-size: 1.1em;
            display: block;
            margin-bottom: 5px;
            letter-spacing: 0.3px;
        }

        .alert-banner i {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        @media (max-width: 768px) {
            .navbar-actions {
                position: static;
                margin-top: 15px;
            }

            .weather-details {
                grid-template-columns: repeat(2, 1fr);
            }

            .forecast-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .schedule-grid {
                grid-template-columns: 1fr;
            }

            .advice-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <script>
        (function () {
            const name = sessionStorage.getItem('userName') || localStorage.getItem('userName');
            const email = sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail');
            if (name) {
                setTimeout(() => {
                    const el = document.getElementById('userName');
                    if (el) el.textContent = name.replace(/["\ [\]]/g, '');
                    const av = document.getElementById('userAvatar');
                    if (av) av.textContent = name.charAt(0).toUpperCase();
                }, 0);
            } else if (email) {
                setTimeout(() => {
                    const n = email.split('@')[0];
                    const el = document.getElementById('userName');
                    if (el) el.textContent = n;
                    const av = document.getElementById('userAvatar');
                    if (av) av.textContent = n.charAt(0).toUpperCase();
                }, 0);
            }
        })();
    </script>
    <nav class="navbar">
        <a href="dashboard.html" class="navbar-brand" style="cursor: pointer;">
            <img src="assets/aquawise_logo.png" alt="AquaWise Logo" class="logo-img">
            <span>AquaWise</span>
        </a>
        <div class="navbar-actions" style="display: flex; align-items: center; gap: 15px;">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName"></span>
            </div>

            <a href="dashboard.html" class="nav-btn-home"
                style="text-decoration: none; color: #666; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 8px; transition: 0.2s;">
                <i class="fas fa-home"></i> Home
            </a>

            <button onclick="handleLogout()" class="nav-btn-logout"
                style="border: none; background: transparent; color: #dc3545; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; padding: 8px 12px; border-radius: 8px; transition: 0.2s;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-cloud-sun"></i> Weather Forecast & Irrigation Planning</h1>
            <p>Real-time weather data for smart water management</p>
            <button class="refresh-btn" onclick="refreshWeatherData()"><i class="fas fa-sync-alt"></i> Refresh Location
                & Weather</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Detecting location and loading weather data...</p>
        </div>

        <div id="weatherContent" style="display: none;">
            <!-- Alert Banner -->
            <div id="alertBanner"></div>

            <!-- Water Savings Calculator -->
            <div class="water-savings" id="waterSavings" style="display: none;">
                <h2><i class="fas fa-hand-holding-water"></i> Predicted Water Savings from Rain</h2>
                <div class="savings-value" id="savingsValue">0 L</div>
                <div class="savings-text" id="savingsText">Expected rainfall will naturally irrigate your crops</div>
            </div>

            <!-- Current Weather -->
            <div class="current-weather">
                <div class="location" id="location">Loading...</div>
                <div class="location-details">
                    <div id="coordinates">Lat: --, Lon: --</div>
                    <div id="accuracy">Accuracy: --</div>
                </div>
                <div class="weather-icon" id="weatherIcon"><i class="fas fa-sun"></i></div>
                <div class="temperature" id="temperature">--¬∞C</div>
                <div class="weather-description" id="description">Loading...</div>

                <div class="weather-details">
                    <div class="detail-box">
                        <div class="detail-icon"><i class="fas fa-tint"></i></div>
                        <div class="detail-value" id="humidity">--%</div>
                        <div class="detail-label">Humidity</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-icon"><i class="fas fa-wind"></i></div>
                        <div class="detail-value" id="windSpeed">-- km/h</div>
                        <div class="detail-label">Wind Speed</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-icon"><i class="fas fa-thermometer-half"></i></div>
                        <div class="detail-value" id="feelsLike">--¬∞C</div>
                        <div class="detail-label">Feels Like</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-icon"><i class="fas fa-tachometer-alt"></i></div>
                        <div class="detail-value" id="pressure">-- hPa</div>
                        <div class="detail-label">Pressure</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-icon"><i class="fas fa-sun"></i></div>
                        <div class="detail-value" id="sunrise">--:--</div>
                        <div class="detail-label">Sunrise</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-icon"><i class="fas fa-moon"></i></div>
                        <div class="detail-value" id="sunset">--:--</div>
                        <div class="detail-label">Sunset</div>
                    </div>
                </div>
            </div>

            <!-- 5-Day Forecast -->
            <div class="forecast-section">
                <h2><i class="fas fa-calendar-alt"></i> 7-Day Weather Forecast</h2>
                <div class="forecast-grid" id="forecastGrid">
                    <!-- Forecast cards will be inserted here -->
                </div>
            </div>

            <!-- 7-Day Irrigation Schedule -->
            <div class="irrigation-schedule">
                <h2><i class="fas fa-clipboard-list"></i> 7-Day Irrigation Schedule</h2>
                <div class="schedule-grid" id="scheduleGrid">
                    <!-- Schedule cards will be inserted here -->
                </div>
            </div>

            <!-- Irrigation Advice -->
            <div class="irrigation-advice">
                <h2><i class="fas fa-lightbulb"></i> Smart Irrigation Recommendations</h2>
                <div class="advice-grid" id="adviceGrid">
                    <!-- Advice cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEATHER_API_KEY = '7941d1d68e6c2211e4eac4a66bab0097';
        const DEFAULT_LAT = 4.1996; // Tapah, Perak
        const DEFAULT_LON = 101.2570;

        let userLat = null;
        let userLon = null;
        let userAccuracy = null;
        let locationName = 'Unknown Location';

        window.addEventListener('DOMContentLoaded', function () {
            checkAuth();
            loadWeatherData();
        });

        function checkAuth() {
            const userName = sessionStorage.getItem('userName') || localStorage.getItem('userName');
            const userEmail = sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail');

            if (!userName && !userEmail) {
                Toast.warning('Please login first!');
                window.location.href = 'index.html';
                return;
            }

            displayUserInfo(userName, userEmail);
        }

        function displayUserInfo(name, email) {
            const userName = name || email || 'User';
            document.getElementById('userName').textContent = userName;
            const initial = userName.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = initial;
        }

        async function getUserLocation() {
            return new Promise(async (resolve) => {
                // 1. CHECK IF GEOLOCATION IS SUPPORTED
                if (!navigator.geolocation) {
                    Toast.error('GPS Not Supported. Your browser does not support location services. Please use the "Pick on Map" button to select your location manually.');
                    userLat = DEFAULT_LAT;
                    userLon = DEFAULT_LON;
                    userAccuracy = 10000; // Very high to indicate it's fake
                    locationName = '‚ö†Ô∏è DEFAULT LOCATION (GPS Not Available)';
                    resolve();
                    return;
                }

                // 2. CHECK PERMISSION STATE (Modern browsers only)
                try {
                    if (navigator.permissions) {
                        const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                        if (permissionStatus.state === 'denied') {
                            Toast.warning('Location access denied. Please enable location in browser settings or use "Pick on Map".');
                            userLat = DEFAULT_LAT;
                            userLon = DEFAULT_LON;
                            userAccuracy = 10000;
                            locationName = '‚ö†Ô∏è DEFAULT LOCATION (Permission Denied)';
                            resolve();
                            return;
                        }
                    }
                } catch (e) {
                    console.log('Permission API not available, continuing...');
                }

                // 3. AGGRESSIVE GPS DETECTION
                const ACCURACY_THRESHOLD = 50; // Accept anything under 50m
                const ACCEPTABLE_THRESHOLD = 500; // Will accept up to 500m if GPS struggles
                let bestPosition = null;
                let bestAccuracy = Infinity;
                let attempts = 0;
                let gpsLocked = false;

                console.log('üõ∞Ô∏è Starting GPS location detection (60s timeout)...');

                const watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        attempts++;
                        const acc = position.coords.accuracy;

                        console.log(`GPS Attempt ${attempts}: Accuracy = ${acc.toFixed(0)}m`);

                        // Always keep the best position we've seen
                        if (acc < bestAccuracy) {
                            bestAccuracy = acc;
                            bestPosition = position;
                            userLat = position.coords.latitude;
                            userLon = position.coords.longitude;
                            userAccuracy = acc;
                        }

                        // If we get excellent accuracy, stop immediately
                        if (acc <= ACCURACY_THRESHOLD && !gpsLocked) {
                            gpsLocked = true;
                            console.log('‚úÖ Excellent GPS lock achieved!');
                            navigator.geolocation.clearWatch(watchId);
                            resolve();
                        }
                    },
                    (error) => {
                        console.error('‚ùå Geolocation Error:', error.code, error.message);
                        navigator.geolocation.clearWatch(watchId);

                        let errorMsg = '';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'üö´ Location Permission Denied\\n\\nPlease allow location access in your browser settings.\\n\\nOR click \"Pick on Map\" to select your location manually.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'üì° GPS Signal Unavailable\\n\\nYour device cannot determine your location.\\n\\nTry:\\n‚Ä¢ Moving near a window\\n‚Ä¢ Enabling GPS on your device\\n‚Ä¢ Using \"Pick on Map\" instead';
                                break;
                            case error.TIMEOUT:
                                errorMsg = '‚è±Ô∏è GPS Timeout\\n\\nLocation detection took too long.\\n\\nPlease use \"Pick on Map\" to select your location.';
                                break;
                        }

                        if (errorMsg) Toast.error(errorMsg);

                        userLat = DEFAULT_LAT;
                        userLon = DEFAULT_LON;
                        userAccuracy = 10000;
                        locationName = '‚ö†Ô∏è DEFAULT LOCATION (GPS Error - Use \"Pick on Map\")';
                        resolve();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 60000, // 60 seconds - give GPS plenty of time
                        maximumAge: 0   // Don't use cached location
                    }
                );

                // OUTER TIMEOUT: Wait up to 60 seconds for GPS lock
                setTimeout(() => {
                    if (!gpsLocked) {
                        navigator.geolocation.clearWatch(watchId);

                        // If we got SOMETHING reasonable, use it
                        if (bestAccuracy < ACCEPTABLE_THRESHOLD && bestPosition) {
                            console.log(`‚ö†Ô∏è Using best available position: ${bestAccuracy.toFixed(0)}m accuracy`);
                            userLat = bestPosition.coords.latitude;
                            userLon = bestPosition.coords.longitude;
                            userAccuracy = bestAccuracy;
                            resolve();
                        } else {
                            // GPS completely failed
                            console.error('‚ùå GPS failed to get acceptable accuracy');
                            Toast.warning('GPS Detection Failed. Could not detect your exact location. Showing default location. Please use "Pick on Map" to select your actual location for accurate weather data.');
                            userLat = DEFAULT_LAT;
                            userLon = DEFAULT_LON;
                            userAccuracy = 10000;
                            locationName = '‚ö†Ô∏è DEFAULT LOCATION (GPS Failed - Use \"Pick on Map\")';
                            resolve();
                        }
                    }
                }, 60000); // 60 second total timeout
            });
        }

        async function loadWeatherData() {
            try {
                document.getElementById('loading').innerHTML = '<div class="spinner"></div><p>Detecting your location...</p>';

                await getUserLocation();

                document.getElementById('loading').innerHTML = '<div class="spinner"></div><p>Fetching weather data...</p>';

                // Fetch weather data
                const weatherData = await fetchWeatherData();
                const forecastData = await fetchForecastData();

                // Display all data
                displayLocationInfo();
                displayCurrentWeather(weatherData);
                displayForecast(forecastData);
                generateIrrigationSchedule(forecastData);
                generateIrrigationAdvice(weatherData, forecastData);
                calculateWaterSavings(forecastData);
                showWeatherAlerts(weatherData, forecastData);

                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('weatherContent').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Error Loading Weather Data</strong>
                        <p>${error.message}</p>
                        <button class="refresh-btn" onclick="location.reload()">Retry</button>
                    </div>
                `;
            }
        }

        async function fetchWeatherData() {
            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${userLat}&lon=${userLon}&appid=${WEATHER_API_KEY}&units=metric`;
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Weather API failed');
            const data = await response.json();

            // Get location name
            if (data.name) {
                locationName = `${data.name}, ${data.sys.country}`;
            } else {
                const geoApiUrl = `https://api.openweathermap.org/geo/1.0/reverse?lat=${userLat}&lon=${userLon}&limit=1&appid=${WEATHER_API_KEY}`;
                try {
                    const geoResponse = await fetch(geoApiUrl);
                    const geoData = await geoResponse.json();
                    if (geoData && geoData.length > 0) {
                        locationName = `${geoData[0].name}, ${geoData[0].state || geoData[0].country}`;
                    }
                } catch (e) {
                    locationName = `Lat: ${userLat.toFixed(4)}, Lon: ${userLon.toFixed(4)}`;
                }
            }

            return data;
        }

        async function fetchForecastData() {
            const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${userLat}&lon=${userLon}&appid=${WEATHER_API_KEY}&units=metric`;
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Forecast API failed');
            return await response.json();
        }

        function displayLocationInfo() {
            document.getElementById('location').textContent = locationName;
            document.getElementById('coordinates').textContent = `üìç Lat: ${userLat.toFixed(6)}, Lon: ${userLon.toFixed(6)}`;

            // Show accuracy with visual indicator
            let accuracyText = `Accuracy: ¬±${userAccuracy.toFixed(0)} meters`;
            let accuracyColor = '#28a745'; // Green

            if (userAccuracy <= 50) {
                accuracyText += ' üéØ (Excellent)';
                accuracyColor = '#28a745';
            } else if (userAccuracy <= 200) {
                accuracyText += ' ‚úÖ (Good)';
                accuracyColor = '#ffc107';
            } else if (userAccuracy <= 1000) {
                accuracyText += ' ‚ö†Ô∏è (Approximate)';
                accuracyColor = '#ff9800';
            } else {
                accuracyText += ' üìç (Default Location)';
                accuracyColor = '#dc3545';
            }

            const accuracyElement = document.getElementById('accuracy');
            accuracyElement.textContent = accuracyText;
            accuracyElement.style.color = accuracyColor;
            accuracyElement.style.fontWeight = '600';
        }

        function displayCurrentWeather(data) {
            document.getElementById('temperature').textContent = Math.round(data.main.temp) + '¬∞C';
            document.getElementById('description').textContent = data.weather[0].description;
            document.getElementById('humidity').textContent = data.main.humidity + '%';
            document.getElementById('windSpeed').textContent = (data.wind.speed * 3.6).toFixed(1) + ' km/h';
            document.getElementById('feelsLike').textContent = Math.round(data.main.feels_like) + '¬∞C';
            document.getElementById('pressure').textContent = data.main.pressure + ' hPa';

            // Sunrise/Sunset
            const sunrise = new Date(data.sys.sunrise * 1000);
            const sunset = new Date(data.sys.sunset * 1000);
            document.getElementById('sunrise').textContent = sunrise.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('sunset').textContent = sunset.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            // Weather icon
            const iconCode = data.weather[0].main.toLowerCase();
            const icons = {
                'clear': '<i class="fas fa-sun text-warning"></i>',
                'clouds': '<i class="fas fa-cloud text-secondary"></i>',
                'rain': '<i class="fas fa-cloud-showers-heavy text-info"></i>',
                'drizzle': '<i class="fas fa-cloud-rain text-info"></i>',
                'thunderstorm': '<i class="fas fa-bolt text-warning"></i>',
                'snow': '<i class="fas fa-snowflake text-info"></i>',
                'mist': '<i class="fas fa-smog text-secondary"></i>',
                'fog': '<i class="fas fa-smog text-secondary"></i>',
                'haze': '<i class="fas fa-smog text-secondary"></i>'
            };
            document.getElementById('weatherIcon').innerHTML = icons[iconCode] || '<i class="fas fa-cloud-sun"></i>';
        }

        function displayForecast(data) {
            const forecastGrid = document.getElementById('forecastGrid');
            forecastGrid.innerHTML = '';

            // Get one forecast per day (at noon)
            const dailyForecasts = data.list.filter(item => item.dt_txt.includes('12:00:00')).slice(0, 7);

            dailyForecasts.forEach((forecast, index) => {
                const date = new Date(forecast.dt * 1000);
                const dayName = index === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                const iconCode = forecast.weather[0].main.toLowerCase();
                const icons = {
                    'clear': '<i class="fas fa-sun text-warning"></i>',
                    'clouds': '<i class="fas fa-cloud text-secondary"></i>',
                    'rain': '<i class="fas fa-cloud-showers-heavy text-info"></i>',
                    'drizzle': '<i class="fas fa-cloud-rain text-info"></i>',
                    'thunderstorm': '<i class="fas fa-bolt text-warning"></i>',
                    'snow': '<i class="fas fa-snowflake text-info"></i>',
                    'mist': '<i class="fas fa-smog text-secondary"></i>'
                };

                // Calculate rain amount
                const rainAmount = forecast.rain ? (forecast.rain['3h'] || 0) : 0;
                const rainHTML = rainAmount > 0 ? `<div class="forecast-rain"><i class="fas fa-umbrella"></i> ${rainAmount.toFixed(1)} mm</div>` : '';

                const card = document.createElement('div');
                card.className = 'forecast-card';
                card.innerHTML = `
                    <div class="forecast-day">${dayName}</div>
                    <div class="forecast-date">${dateStr}</div>
                    <div class="forecast-icon">${icons[iconCode] || '<i class="fas fa-cloud-sun"></i>'}</div>
                    <div class="forecast-temp">${Math.round(forecast.main.temp)}¬∞C</div>
                    <div class="forecast-desc">${forecast.weather[0].description}</div>
                    ${rainHTML}
                `;
                forecastGrid.appendChild(card);
            });
        }

        function generateIrrigationSchedule(data) {
            const scheduleGrid = document.getElementById('scheduleGrid');
            scheduleGrid.innerHTML = '';

            const dailyForecasts = data.list.filter(item => item.dt_txt.includes('12:00:00')).slice(0, 7);

            dailyForecasts.forEach((forecast, index) => {
                const date = new Date(forecast.dt * 1000);
                const dayName = index === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                const temp = forecast.main.temp;
                const rainAmount = forecast.rain ? (forecast.rain['3h'] || 0) : 0;
                const humidity = forecast.main.humidity;

                let action, reason, cardClass;

                if (rainAmount > 5) {
                    action = '<i class="fas fa-check-circle"></i> Skip Irrigation';
                    reason = `${rainAmount.toFixed(1)}mm rain expected - natural watering`;
                    cardClass = 'skip';
                } else if (rainAmount > 2) {
                    action = '<i class="fas fa-exclamation-triangle"></i> Reduce by 50%';
                    reason = `Light rain (${rainAmount.toFixed(1)}mm) will supplement`;
                    cardClass = 'caution';
                } else if (temp > 35) {
                    action = '<i class="fas fa-fire"></i> Increase Irrigation';
                    reason = `High temp (${temp.toFixed(0)}¬∞C) - more evaporation`;
                    cardClass = 'irrigate';
                } else if (humidity < 40) {
                    action = '<i class="fas fa-tint"></i> Normal + 20%';
                    reason = `Low humidity (${humidity}%) - faster drying`;
                    cardClass = 'irrigate';
                } else if (temp < 20) {
                    action = '<i class="fas fa-leaf"></i> Reduce by 30%';
                    reason = `Cool weather (${temp.toFixed(0)}¬∞C) - less evaporation`;
                    cardClass = 'caution';
                } else {
                    action = '<i class="fas fa-check"></i> Normal Irrigation';
                    reason = 'Conditions are optimal';
                    cardClass = 'schedule-card';
                }

                const card = document.createElement('div');
                card.className = `schedule-card ${cardClass}`;
                card.innerHTML = `
                    <div class="schedule-day">${dayName}</div>
                    <div style="font-size: 0.85em; color: #999; margin-bottom: 10px;">${dateStr}</div>
                    <div class="schedule-action"><strong>${action}</strong></div>
                    <div class="schedule-reason">${reason}</div>
                `;
                scheduleGrid.appendChild(card);
            });
        }

        function generateIrrigationAdvice(current, forecast) {
            const adviceGrid = document.getElementById('adviceGrid');
            adviceGrid.innerHTML = '';

            const advice = [];

            // Current Temperature Advice
            if (current.main.temp > 35) {
                advice.push({
                    title: '<i class="fas fa-thermometer-full"></i> High Temperature Alert',
                    text: `Current temperature is ${current.main.temp.toFixed(1)}¬∞C. Increase irrigation by 30% and water during early morning (6-8 AM) or evening (6-8 PM) to minimize evaporation losses.`
                });
            } else if (current.main.temp < 15) {
                advice.push({
                    title: '<i class="fas fa-snowflake"></i> Cool Weather',
                    text: `Temperature is ${current.main.temp.toFixed(1)}¬∞C. Reduce watering by 20-30% as plants require less water in cooler conditions and evaporation is minimal.`
                });
            } else {
                advice.push({
                    title: '<i class="fas fa-check-circle"></i> Optimal Temperature',
                    text: `Temperature is ${current.main.temp.toFixed(1)}¬∞C - ideal for most crops. Maintain your regular irrigation schedule.`
                });
            }

            // Humidity Advice
            if (current.main.humidity > 80) {
                advice.push({
                    title: '<i class="fas fa-tint"></i> High Humidity',
                    text: `Humidity at ${current.main.humidity}%. Soil retains moisture better in humid conditions. Reduce irrigation by 10-15% to prevent waterlogging and fungal diseases.`
                });
            } else if (current.main.humidity < 40) {
                advice.push({
                    title: '<i class="fas fa-wind"></i> Low Humidity Warning',
                    text: `Humidity only ${current.main.humidity}%. Plants lose water faster through transpiration. Increase watering by 15-20% and consider mulching to retain soil moisture.`
                });
            }

            // Rain Forecast
            const rainInForecast = forecast.list.slice(0, 16).filter(item => {
                return item.rain && item.rain['3h'] > 0;
            });

            if (rainInForecast.length > 0) {
                const totalRain = rainInForecast.reduce((sum, item) => sum + (item.rain['3h'] || 0), 0);
                advice.push({
                    title: '<i class="fas fa-cloud-showers-heavy"></i> Rain Expected',
                    text: `${totalRain.toFixed(1)}mm of rain forecasted in the next 48 hours. Delay irrigation and let nature water your crops naturally. This will save water and reduce costs.`
                });
            } else {
                advice.push({
                    title: '<i class="fas fa-sun"></i> No Rain Forecasted',
                    text: 'No significant rainfall expected in the next 7 days. Ensure consistent irrigation schedule to maintain optimal soil moisture for crop growth.'
                });
            }

            // Wind Advisory
            if (current.wind.speed > 5) {
                advice.push({
                    title: '<i class="fas fa-wind"></i> Windy Conditions',
                    text: `Wind speed: ${(current.wind.speed * 3.6).toFixed(1)} km/h. Strong winds increase water loss through drift and evaporation. Use drip irrigation or water early morning when winds are calmer.`
                });
            }

            // Best Irrigation Time
            const hour = new Date().getHours();
            const sunrise = new Date(current.sys.sunrise * 1000).getHours();
            const sunset = new Date(current.sys.sunset * 1000).getHours();

            if (hour >= sunrise && hour <= sunrise + 2) {
                advice.push({
                    title: '<i class="fas fa-clock"></i> Perfect Timing - Morning Golden Hour',
                    text: `It's currently ${hour}:00 - the BEST time to irrigate! Morning watering (6-8 AM) allows plants to absorb water before heat peaks, minimizing evaporation by up to 40%.`
                });
            } else if (hour >= sunset - 2 && hour <= sunset) {
                advice.push({
                    title: '<i class="fas fa-clock"></i> Good Timing - Evening Window',
                    text: `It's ${hour}:00 - a good time to irrigate. Evening watering (5-7 PM) is effective but ensure leaves dry before nightfall to prevent fungal diseases.`
                });
            } else if (hour >= 11 && hour <= 15) {
                advice.push({
                    title: '<i class="fas fa-exclamation-circle"></i> Avoid Midday Irrigation',
                    text: `It's ${hour}:00 - the WORST time to water! Midday irrigation loses 50-70% water to evaporation. Wait until evening (after 5 PM) or tomorrow morning (6-8 AM).`
                });
            } else {
                advice.push({
                    title: '<i class="fas fa-clock"></i> Optimal Irrigation Windows',
                    text: `Best times to irrigate: Early morning (6-8 AM) for maximum absorption, or Evening (5-7 PM) to minimize evaporation. Avoid watering between 11 AM - 3 PM.`
                });
            }

            // Crop-Specific Advice
            advice.push({
                title: '<i class="fas fa-seedling"></i> General Crop Care',
                text: 'Monitor soil moisture at root depth (6-12 inches). Most crops need 25-50mm water per week. Adjust based on crop type, growth stage, and weather conditions.'
            });

            // Display advice
            advice.forEach(item => {
                const card = document.createElement('div');
                card.className = 'advice-card';
                card.innerHTML = `
                    <h3>${item.title}</h3>
                    <p>${item.text}</p>
                `;
                adviceGrid.appendChild(card);
            });
        }

        function calculateWaterSavings(forecast) {
            // Calculate total expected rainfall in next 7 days
            const totalRain = forecast.list.reduce((sum, item) => {
                return sum + (item.rain ? (item.rain['3h'] || 0) : 0);
            }, 0);

            if (totalRain > 10) {
                // Assume 1mm rain = 1L per m¬≤ = 10,000L per hectare
                // Average field size 1-5 hectares
                const avgFieldSize = 2; // hectares
                const waterSaved = totalRain * 10000 * avgFieldSize;

                document.getElementById('waterSavings').style.display = 'block';
                document.getElementById('savingsValue').textContent = `${waterSaved.toLocaleString()} L`;
                document.getElementById('savingsText').textContent = `Estimated water savings from ${totalRain.toFixed(1)}mm forecasted rain over the next 7 days (based on ${avgFieldSize}ha field)`;
            } else {
                document.getElementById('waterSavings').style.display = 'none';
            }
        }

        function showWeatherAlerts(current, forecast) {
            const alertBanner = document.getElementById('alertBanner');
            alertBanner.innerHTML = '';

            // Extreme temperature alert
            if (current.main.temp > 40) {
                alertBanner.innerHTML = `
                    <div class="alert-banner danger">
                        <span style="font-size: 1.5em;"><i class="fas fa-fire"></i></span>
                        <div>
                            <strong>EXTREME HEAT WARNING!</strong> Temperature exceeds 40¬∞C. 
                            Increase irrigation immediately and provide shade for sensitive crops.
                        </div>
                    </div>
                `;
            } else if (current.main.temp < 5) {
                alertBanner.innerHTML = `
                    <div class="alert-banner danger">
                        <span style="font-size: 1.5em;"><i class="fas fa-snowflake"></i></span>
                        <div>
                            <strong>FROST WARNING!</strong> Temperature near freezing. 
                            Protect sensitive crops and consider covering plants overnight.
                        </div>
                    </div>
                `;
            }

            // Heavy rain alert
            const heavyRain = forecast.list.slice(0, 8).some(item =>
                item.rain && item.rain['3h'] > 15
            );

            if (heavyRain) {
                alertBanner.innerHTML += `
                    <div class="alert-banner warning">
                        <span style="font-size: 1.5em;"><i class="fas fa-cloud-showers-heavy"></i></span>
                        <div>
                            <strong>HEAVY RAIN ALERT!</strong> Significant rainfall expected in next 24 hours. 
                            Skip all irrigation to prevent waterlogging and soil erosion.
                        </div>
                    </div>
                `;
            }

            // Perfect conditions alert
            if (current.main.temp >= 20 && current.main.temp <= 30 &&
                current.main.humidity >= 50 && current.main.humidity <= 70 &&
                !heavyRain) {
                alertBanner.innerHTML += `
                    <div class="alert-banner success">
                        <span style="font-size: 1.5em;"><i class="fas fa-check-circle"></i></span>
                        <div>
                            <strong>IDEAL CONDITIONS!</strong> Temperature and humidity are perfect for crop growth. 
                            Maintain regular irrigation schedule for optimal yields.
                        </div>
                    </div>
                `;
            }
        }

        async function refreshWeatherData() {
            document.getElementById('weatherContent').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').innerHTML = `
                <div class="spinner"></div>
                <p><i class="fas fa-sync-alt fa-spin"></i> Refreshing your location and weather data...</p>
                <p style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">
                    This may take a few seconds for high accuracy
                </p>
            `;

            // Reset location variables to force fresh detection
            userLat = null;
            userLon = null;
            userAccuracy = null;
            locationName = 'Unknown Location';

            await loadWeatherData();
        }

        // Logout function
        function handleLogout() {
            sessionStorage.clear();
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            window.location.href = 'index.html';
        }
        window.handleLogout = handleLogout;
    </script>
    <script>window.addEventListener('load', () => document.body.style.opacity = '1');</script>
    <script src="assets/professional-ui.js?v=4"></script>

    <!-- Professional Footer -->
    <footer class="app-footer">
        <div class="footer-simple">
            <h3 class="footer-title">AquaWise</h3>
            <p class="footer-tagline">Smart Irrigation System powered by Machine Learning</p>
            <p class="footer-copyright">
                ¬© 2025 AquaWise | Version 1.0<br>
                <span class="footer-developer">Built by Muhammad Faheem bin Haswanorrizam</span>
            </p>
        </div>
    </footer>
</body>

</html>