<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Water Prediction - Smart Irrigation</title>

    <!-- Firebase Imports (Module) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, push, set } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCYhoMMFuBz3f-T3RcaixPavO3QNTbL4TA",
            authDomain: "smart-irrigation-system-3a5ff.firebaseapp.com",
            databaseURL: "https://smart-irrigation-system-3a5ff-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-irrigation-system-3a5ff",
            storageBucket: "smart-irrigation-system-3a5ff.appspot.com",
            messagingSenderId: "778942848929",
            appId: "1:778942848929:web:a793c928a1ea78b1a635e0",
            measurementId: "G-ZQRXSSSVL7"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        window.firebaseDatabase = database;
        window.firebaseModules = { ref, push, set };
        window.firebaseReady = true;
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 10vh; padding-bottom: 40px; }
        .navbar { background: white; padding: 20px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .navbar-center { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .navbar-brand { display: flex; align-items: center; gap: 15px; font-weight: bold; color: #667eea; letter-spacing: 1px; }
        .navbar-brand .logo { font-size: 4em; }
        .navbar-brand span:not(.logo) { font-size: 2.5em; }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 8px 20px; background: #f5f5f5; border-radius: 25px; font-weight: 600; color: #333; border: 2px solid #e0e0e0; }
        .user-avatar { width: 35px; height: 35px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1em; }
        .nav-buttons { position: absolute; top: 20px; right: 40px; display: flex; gap: 10px; }
        .nav-btn { background: #667eea; border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .nav-btn:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .logout-btn { background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); }
        .logout-btn:hover { background: linear-gradient(135deg, #cc0000 0%, #990000 100%); }
        .container { max-width: 1400px; margin: 40px auto; padding: 0 20px; }
        .page-header { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; text-align: center; }
        .page-header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        .page-header p { color: #666; font-size: 1.1em; }
        .ml-badge { display: inline-block; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 8px 20px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-top: 10px; }
        .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); min-height: 400px; }
        .card h2 { color: #667eea; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #667eea; font-size: 1.5em; }
        .sensor-display { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .location-info { padding: 5px 0 15px 0; border-bottom: 1px solid rgba(255,255,255,0.4); margin-bottom: 10px; } 
        .location-label { font-size: 0.9em; opacity: 0.8; } 
        .location-value { font-size: 1.2em; font-weight: bold; } 
        .coords-value { font-size: 1em; opacity: 0.9; margin-top: 5px;}
        .accuracy-value { font-size: 0.9em; margin-top: 5px; font-weight: 600; }
        .sensor-reading { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .sensor-reading:last-child { border-bottom: none; }
        .sensor-value { font-size: 1.5em; font-weight: bold; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; color: #333; font-weight: 600; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; transition: all 0.3s; }
        input:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 30px; border: none; border-radius: 10px; font-size: 1.05em; font-weight: bold; cursor: pointer; width: 100%; transition: all 0.3s; margin-top: 15px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .prediction-result { grid-column: 1 / -1; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; display: none; animation: slideIn 0.5s ease; }
        .prediction-result.show { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .result-title { font-size: 2em; margin-bottom: 20px; font-weight: bold; }
        .water-amount { font-size: 4em; font-weight: bold; margin: 20px 0; }
        .per-hectare { font-size: 1.3em; margin-bottom: 30px; opacity: 0.9; }
        .comparison-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .comparison-item { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; }
        .comparison-item h4 { font-size: 1.2em; margin-bottom: 10px; }
        .comparison-value { font-size: 2em; font-weight: bold; }
        .recommendation-box { background: rgba(255,255,255,0.2); padding: 25px; border-radius: 10px; margin-top: 20px; text-align: left; }
        .recommendation-box h3 { font-size: 1.5em; margin-bottom: 15px; }
        .recommendation-box ul { list-style: none; padding: 0; }
        .recommendation-box li { padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 1.05em; }
        .recommendation-box li:last-child { border-bottom: none; }
        .info-text { color: #666; font-size: 0.85em; margin-top: 12px; font-style: italic; line-height: 1.4; }
        .refresh-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: all 0.3s; margin-top: 10px; }
        .refresh-btn:hover { background: white; color: #667eea; }
        .map-link-btn { background: #ffffff; color: #333; padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; transition: all 0.3s; text-align: center; text-decoration: none; display: block; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .map-link-btn:hover { background: #f5f5f5; color: #667eea; transform: translateY(-1px); }
        @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .content-grid { grid-template-columns: 1fr; } .comparison-box { grid-template-columns: 1fr; } .nav-buttons { position: static; margin-top: 15px; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-center">
            <div class="navbar-brand">
                <span class="logo">üåæ</span>
                <span>Smart Irrigation System</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">Loading...</span>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="goToDashboard()">üè† Dashboard</button>
            <button class="nav-btn logout-btn" onclick="handleLogout()">üö™ Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>ü§ñ ML Prediction</h1>
            <div class="ml-badge">‚ö° Machine Learning Powered</div>
        </div>

        <div class="content-grid">
            
            <div class="card">
                <h2>üì° Current Sensor Readings</h2>
                <div class="sensor-display">
                    
                    <div class="location-info">
                        <div class="location-label">Detected Location (Reverse Geocoded)</div>
                        <div class="location-value" id="locationDisplay">Loading...</div>
                        <div class="coords-value" id="coordsDisplay">Lat: --, Lon: --</div>
                        <div class="accuracy-value" id="accuracyDisplay">Accuracy: --</div>
                        <div id="mapLinkContainer"></div>
                    </div>

                    <div class="sensor-reading">
                        <span class="sensor-label">Soil Moisture (Est.)</span>
                        <span class="sensor-value" id="sensorMoisture">--</span>
                    </div>
                    <div class="sensor-reading">
                        <span class="sensor-label">Temperature (API)</span>
                        <span class="sensor-value" id="sensorTemp">--</span>
                    </div>
                    <div class="sensor-reading">
                        <span class="sensor-label">Humidity (API)</span>
                        <span class="sensor-value" id="sensorHumidity">--</span>
                    </div>
                    <div class="sensor-reading">
                        <span class="sensor-label">Rainfall (API 24h)</span>
                        <span class="sensor-value" id="sensorRainfall">--</span>
                    </div>
                </div>

                <button class="refresh-btn" onclick="refreshLocation()">üìç Auto-Detect / Refresh Location & Data</button>
                <p class="info-text" id="locationInfo">Click button to detect your location...</p>
            </div>

            <div class="card">
                <h2>üìù Prediction Input</h2>
                <form id="predictionForm" onsubmit="handlePrediction(event)">
                    <div class="form-group">
                        <label for="cropType">Crop Type</label>
                        <select id="cropType" required>
                            <option value="">-- Select Crop --</option>
                            <option value="rice">Rice</option>
                            <option value="maize">Maize</option>
                            <option value="pomegranate">Pomegranate</option>
                            <option value="banana">Banana</option>
                            <option value="mango">Mango</option>
                            <option value="watermelon">Watermelon</option>
                            <option value="papaya">Papaya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="soilMoisture">Soil Moisture (%)</label>
                        <input type="number" id="soilMoisture" min="0" max="100" step="0.1" required placeholder="e.g., 45.2">
                    </div>
                    <div class="form-group">
                        <label for="temperature">Temperature (¬∞C)</label>
                        <input type="number" id="temperature" min="0" max="50" step="0.1" required placeholder="e.g., 28.5">
                    </div>
                    <div class="form-group">
                        <label for="humidity">Humidity (%)</label>
                        <input type="number" id="humidity" min="0" max="100" step="0.1" required placeholder="e.g., 65.3">
                    </div>
                    <div class="form-group">
                        <label for="rainfall">Rainfall (mm)</label>
                        <input type="number" id="rainfall" min="0" max="500" step="0.1" required placeholder="e.g., 2.1">
                    </div>
                    <div class="form-group">
                        <label for="fieldSize">Field Size (ha)</label>
                        <input type="number" id="fieldSize" min="0.1" step="0.1" required placeholder="e.g., 1.5">
                    </div>
                    <button type="submit" class="btn-primary" id="submitBtn">
                        ü§ñ Predict with ML
                    </button>
                </form>
            </div>

            <div class="prediction-result" id="predictionResult">
                <div class="result-title">üíß ML Prediction Results</div>
                <div class="water-amount" id="waterAmount">0 L</div>
                <div class="per-hectare">Per Hectare: <span id="perHectare">0 L/ha</span></div>
                
                <div class="comparison-box">
                    <div class="comparison-item">
                        <h4>ü§ñ ML Model</h4>
                        <div class="comparison-value" id="mlPrediction">0 L/ha</div>
                    </div>
                    <div class="comparison-item">
                        <h4>üìê Rule-Based</h4>
                        <div class="comparison-value" id="rulePrediction">0 L/ha</div>
                    </div>
                </div>

                <div class="recommendation-box">
                    <h3>üìã Smart Recommendations</h3>
                    <ul id="recommendationList"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const FLASK_API_URL = 'http://localhost:5000/predict';
        const WEATHER_API_KEY = '7941d1d68e6c2211e4eac4a66bab0097';
        
        const CROP_BASE_VALUES = {
            'rice': 6500, 'maize': 5000, 'pomegranate': 4400,
            'banana': 5100, 'mango': 4600, 'watermelon': 4700, 'papaya': 4850
        };
        
        // DEFAULT LOCATION: Only used as LAST RESORT
        const DEFAULT_LAT = 4.1996;  // Tapah, Perak
        const DEFAULT_LON = 101.2570;
        
        let userLat = null;
        let userLon = null;
        let userAccuracy = null;
        let locationName = 'Unknown Location';

        window.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            // Auto-detect location on page load
            refreshLocation();
        });
        
        // --- EXACT SAME LOCATION DETECTION AS WEATHER.HTML ---
        async function getUserLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log('‚ùå Geolocation not supported, using default location');
                    userLat = DEFAULT_LAT;
                    userLon = DEFAULT_LON;
                    userAccuracy = 1000;
                    locationName = 'Tapah, Perak, Malaysia (Default)';
                    resolve();
                    return;
                }

                const ACCURACY_THRESHOLD = 50; // High accuracy target
                const LAPTOP_ACCURACY_THRESHOLD = 200; // Acceptable for laptops
                let bestAccuracy = Infinity;
                let attempts = 0;
                const maxAttempts = 3;

                console.log('üìç Starting high-accuracy location detection...');

                const watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        attempts++;
                        const currentAccuracy = position.coords.accuracy;
                        
                        console.log(`üìç Location attempt ${attempts}: Accuracy ${currentAccuracy.toFixed(0)}m`);
                        console.log(`   Lat: ${position.coords.latitude.toFixed(6)}, Lon: ${position.coords.longitude.toFixed(6)}`);

                        // Accept if accuracy meets threshold OR if we've tried enough times
                        const shouldAccept = currentAccuracy <= ACCURACY_THRESHOLD || 
                                           (attempts >= maxAttempts && currentAccuracy <= LAPTOP_ACCURACY_THRESHOLD);

                        if (shouldAccept && currentAccuracy < bestAccuracy) {
                            userLat = position.coords.latitude;
                            userLon = position.coords.longitude;
                            userAccuracy = currentAccuracy;
                            bestAccuracy = currentAccuracy;

                            console.log(`‚úÖ Location accepted: ${userLat.toFixed(6)}, ${userLon.toFixed(6)} (${userAccuracy.toFixed(0)}m)`);

                            if (currentAccuracy <= ACCURACY_THRESHOLD) {
                                console.log('üéØ High accuracy achieved!');
                                navigator.geolocation.clearWatch(watchId);
                                resolve();
                            } else if (attempts >= maxAttempts) {
                                console.log('‚úÖ Acceptable accuracy after multiple attempts');
                                navigator.geolocation.clearWatch(watchId);
                                resolve();
                            }
                        } else {
                            console.log(`‚è≥ Refining location... (current: ${currentAccuracy.toFixed(0)}m, target: ${ACCURACY_THRESHOLD}m)`);
                        }
                    },
                    (error) => {
                        console.error('‚ùå Geolocation Error:', error.code, error.message);
                        navigator.geolocation.clearWatch(watchId);
                        
                        // Use default location
                        userLat = DEFAULT_LAT;
                        userLon = DEFAULT_LON;
                        userAccuracy = 1000;
                        locationName = 'Tapah, Perak, Malaysia (Default - Location Access Denied)';
                        
                        if (error.code === error.PERMISSION_DENIED) {
                            console.log('‚ùå Location permission denied by user');
                        } else if (error.code === error.TIMEOUT) {
                            console.log('‚è±Ô∏è Location timeout');
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            console.log('‚ùå Location unavailable');
                        }
                        
                        resolve();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000, // 15 seconds per attempt
                        maximumAge: 0 // Don't use cached location
                    }
                );

                // Fallback timeout: Accept best location after 20 seconds
                setTimeout(() => {
                    if (!userLat || userAccuracy === null) {
                        navigator.geolocation.clearWatch(watchId);
                        
                        if (bestAccuracy < Infinity && bestAccuracy <= LAPTOP_ACCURACY_THRESHOLD) {
                            // Use the best location we got
                            console.log(`‚è∞ Timeout reached, using best available location (${bestAccuracy.toFixed(0)}m)`);
                            resolve();
                        } else {
                            // Use default location
                            console.log('‚è∞ Timeout reached, using default location');
                            userLat = DEFAULT_LAT;
                            userLon = DEFAULT_LON;
                            userAccuracy = 1000;
                            locationName = 'Tapah, Perak, Malaysia (Default - Timeout)';
                            resolve();
                        }
                    }
                }, 20000);
            });
        }

        async function refreshLocation() {
            document.getElementById('locationInfo').textContent = 'üìç Detecting your precise location...';
            document.getElementById('locationDisplay').textContent = 'Detecting...';
            
            await getUserLocation();
            await updateSensorDisplay();
        }

        async function fetchWeatherData() {
            if (userLat === null || userLon === null) {
                return {
                    moisture: '--',
                    temperature: '--',
                    humidity: '--',
                    rainfall: '--',
                    location: 'Location Required'
                };
            }
            
            const geoApiUrl = `https://api.openweathermap.org/geo/1.0/reverse?lat=${userLat}&lon=${userLon}&limit=1&appid=${WEATHER_API_KEY}`;
            let locationNameTemp = `Lat: ${userLat.toFixed(4)}, Lon: ${userLon.toFixed(4)}`;
            
            try {
                const geoResponse = await fetch(geoApiUrl);
                if (geoResponse.ok) {
                    const geoData = await geoResponse.json();
                    if (geoData && geoData.length > 0) {
                        const city = geoData[0].name || '';
                        const state = geoData[0].state || '';
                        const country = geoData[0].country || '';
                        
                        if (city && state) {
                            locationNameTemp = `${city}, ${state}`;
                        } else if (city) {
                            locationNameTemp = `${city}, ${country}`;
                        } else if (state) {
                            locationNameTemp = `${state}, ${country}`;
                        } else {
                            locationNameTemp = country;
                        }
                    }
                }
            } catch (e) {
                console.error("Geo API error:", e);
            }

            // Fetch both current weather and forecast (same as weather.html)
            const currentWeatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${userLat}&lon=${userLon}&appid=${WEATHER_API_KEY}&units=metric`;
            const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${userLat}&lon=${userLon}&appid=${WEATHER_API_KEY}&units=metric`;

            try {
                const [currentResponse, forecastResponse] = await Promise.all([
                    fetch(currentWeatherUrl),
                    fetch(forecastUrl)
                ]);
                
                if (!currentResponse.ok) throw new Error('Weather API failed');
                
                const currentData = await currentResponse.json();
                const humidity = currentData.main.humidity;
                const temperature = currentData.main.temp;
                
                // ‚úÖ Get TODAY'S forecast rainfall (same logic as weather.html)
                let todayRainfall = 0;
                
                if (forecastResponse.ok) {
                    const forecastData = await forecastResponse.json();
                    
                    // Get today's forecast at noon (same as weather.html displayForecast)
                    const todayForecast = forecastData.list.find(item => item.dt_txt.includes('12:00:00'));
                    
                    if (todayForecast && todayForecast.rain) {
                        todayRainfall = todayForecast.rain['3h'] || 0;
                    }
                    
                    // If no forecast at noon yet, get next available forecast with rain
                    if (todayRainfall === 0) {
                        const nextRainForecast = forecastData.list.slice(0, 3).find(item => item.rain);
                        if (nextRainForecast && nextRainForecast.rain) {
                            todayRainfall = nextRainForecast.rain['3h'] || 0;
                        }
                    }
                }

                // Calculate estimated soil moisture based on forecast rain
                let moisture = (humidity * 0.7) + (todayRainfall * 2);
                if (todayRainfall > 1) moisture = Math.min(90, moisture + 20);
                if (temperature > 30) moisture = moisture * 0.9;

                if (locationNameTemp.includes('Lat:') && currentData.name) {
                    locationNameTemp = `${currentData.name}, ${currentData.sys.country}`;
                }

                locationName = locationNameTemp;

                return {
                    moisture: Math.min(100, Math.max(20, moisture)).toFixed(1),
                    temperature: temperature.toFixed(1),
                    humidity: humidity.toFixed(1),
                    rainfall: todayRainfall.toFixed(1),
                    location: locationName
                };

            } catch (error) {
                console.warn("Weather API failed:", error);
                return {
                    moisture: '--',
                    temperature: '--',
                    humidity: '--',
                    rainfall: '--',
                    location: locationNameTemp
                };
            }
        }

        async function updateSensorDisplay() {
            const data = await fetchWeatherData();
            
            const locationDisplayElement = document.getElementById('locationDisplay');
            const coordsDisplayElement = document.getElementById('coordsDisplay');
            const accuracyDisplayElement = document.getElementById('accuracyDisplay');
            const mapLinkContainer = document.getElementById('mapLinkContainer');
            
            document.getElementById('sensorMoisture').textContent = data.moisture + (data.moisture !== '--' ? '%' : '');
            document.getElementById('sensorTemp').textContent = data.temperature + (data.temperature !== '--' ? '¬∞C' : '');
            document.getElementById('sensorHumidity').textContent = data.humidity + (data.humidity !== '--' ? '%' : '');
            document.getElementById('sensorRainfall').textContent = data.rainfall + (data.rainfall !== '--' ? ' mm' : '');
            
            mapLinkContainer.innerHTML = '';
            locationDisplayElement.textContent = data.location;
            coordsDisplayElement.textContent = `üìç Lat: ${userLat.toFixed(6)}, Lon: ${userLon.toFixed(6)}`;
            
            // Show accuracy with visual indicator
            let accuracyText = `Accuracy: ¬±${userAccuracy.toFixed(0)} meters`;
            let accuracyColor = '#28a745';
            
            if (userAccuracy <= 50) {
                accuracyText += ' üéØ (Excellent)';
                accuracyColor = '#28a745';
            } else if (userAccuracy <= 200) {
                accuracyText += ' ‚úÖ (Good)';
                accuracyColor = '#ffc107';
            } else if (userAccuracy <= 1000) {
                accuracyText += ' ‚ö†Ô∏è (Approximate)';
                accuracyColor = '#ff9800';
            } else {
                accuracyText += ' üìç (Default Location)';
                accuracyColor = '#dc3545';
            }
            
            accuracyDisplayElement.textContent = accuracyText;
            accuracyDisplayElement.style.color = accuracyColor;
            
            if (userLat && userLon && data.moisture !== '--') {
                document.getElementById('locationInfo').textContent = `‚úÖ Weather data loaded for ${data.location}. Ready for prediction!`;
                
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${userLat},${userLon}`;
                const mapLink = document.createElement('a');
                mapLink.href = mapUrl;
                mapLink.target = '_blank';
                mapLink.className = 'map-link-btn';
                mapLink.textContent = 'üó∫Ô∏è View Location on Map';
                mapLinkContainer.appendChild(mapLink);
                
                document.getElementById('soilMoisture').value = data.moisture;
                document.getElementById('temperature').value = data.temperature;
                document.getElementById('humidity').value = data.humidity;
                document.getElementById('rainfall').value = data.rainfall;
            } else if (data.moisture === '--') {
                document.getElementById('locationInfo').textContent = `‚ö†Ô∏è Location detected but weather API failed. Try refreshing.`;
            }
        }

        async function handlePrediction(event) {
            event.preventDefault();
            
            if (userLat === null || userLon === null) {
                alert('Location data is required for prediction. Please click "Auto-Detect / Refresh Location & Data" button first.');
                return;
            }

            const cropType = document.getElementById('cropType').value;
            const soilMoisture = parseFloat(document.getElementById('soilMoisture').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const humidity = parseFloat(document.getElementById('humidity').value);
            const rainfall = parseFloat(document.getElementById('rainfall').value);
            const fieldSize = parseFloat(document.getElementById('fieldSize').value);

            if (!cropType || isNaN(soilMoisture) || isNaN(temperature) || isNaN(humidity) || isNaN(rainfall) || isNaN(fieldSize)) {
                alert('Please ensure all required fields are filled with valid numbers.');
                return;
            }

            const cropBase = CROP_BASE_VALUES[cropType] || 4000;
            
            const data = {
                crop_type: cropType,
                soil_moisture_percent: soilMoisture,
                temperature_celsius: temperature,
                humidity_percent: humidity,
                rainfall_mm: rainfall,
                crop_water_base: cropBase
            };

            try {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Predicting...';

                const response = await fetch(FLASK_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                submitBtn.disabled = false;
                submitBtn.textContent = 'ü§ñ Predict with ML';

                if (result.success) {
                    const mlPredictionPerHa = result.water_requirement_liters_per_hectare;
                    const rulePredictionPerHa = predictWithRules({cropType, soilMoisture, temperature, humidity, rainfall});
                    const totalWater = mlPredictionPerHa * fieldSize;

                    document.getElementById('waterAmount').textContent = `${Math.round(totalWater).toLocaleString()} L`;
                    document.getElementById('perHectare').textContent = `${Math.round(mlPredictionPerHa).toLocaleString()} L/ha`;
                    document.getElementById('mlPrediction').textContent = `${Math.round(mlPredictionPerHa).toLocaleString()} L/ha`;
                    document.getElementById('rulePrediction').textContent = `${Math.round(rulePredictionPerHa).toLocaleString()} L/ha`;
                    
                    const recommendations = generateRecommendations(
                        {cropType, soilMoisture, temperature, humidity, rainfall, fieldSize},
                        mlPredictionPerHa,
                        rulePredictionPerHa
                    );
                    const recommendationList = document.getElementById('recommendationList');
                    recommendationList.innerHTML = '';
                    recommendations.forEach(rec => {
                        const li = document.createElement('li');
                        li.textContent = rec;
                        recommendationList.appendChild(li);
                    });

                    const resultCard = document.getElementById('predictionResult');
                    resultCard.classList.add('show');
                    resultCard.scrollIntoView({ behavior: 'smooth' });

                    // Log to Firebase
                    if (window.firebaseReady && window.firebaseDatabase && window.firebaseModules) {
                        const { ref, set } = window.firebaseModules;
                        const db = window.firebaseDatabase;
                        
                        const userEmail = sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail') || 'guest';
                        const userName = sessionStorage.getItem('userName') || localStorage.getItem('userName') || 'Guest User';
                        
                        const sanitizedEmail = userEmail.replace(/[.#$[\]]/g, '_');
                        const timestamp = new Date().toISOString();
                        const predictionId = `prediction_${Date.now()}`;
                        
                        const userPredictionsRef = ref(db, `predictions/${sanitizedEmail}/${predictionId}`);
                        
                        set(userPredictionsRef, {
                            user: {
                                email: userEmail,
                                name: userName
                            },
                            timestamp: timestamp,
                            date: new Date().toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            }),
                            time: new Date().toLocaleTimeString('en-US', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                second: '2-digit'
                            }),
                            location: {
                                name: locationName,
                                coordinates: {
                                    latitude: parseFloat(userLat.toFixed(6)),
                                    longitude: parseFloat(userLon.toFixed(6))
                                },
                                accuracy_meters: parseFloat(userAccuracy.toFixed(0)),
                                source: userAccuracy > 1000 ? 'default' : 'auto'
                            },
                            crop: {
                                type: cropType,
                                type_display: cropType.charAt(0).toUpperCase() + cropType.slice(1)
                            },
                            environmental_data: {
                                soil_moisture_percent: parseFloat(soilMoisture.toFixed(1)),
                                temperature_celsius: parseFloat(temperature.toFixed(1)),
                                humidity_percent: parseFloat(humidity.toFixed(1)),
                                rainfall_mm: parseFloat(rainfall.toFixed(1))
                            },
                            field: {
                                size_hectares: parseFloat(fieldSize.toFixed(2)),
                                crop_base_water: cropBase
                            },
                            predictions: {
                                ml_model: {
                                    total_water_liters: Math.round(totalWater),
                                    water_per_hectare_liters: Math.round(mlPredictionPerHa)
                                },
                                rule_based: {
                                    water_per_hectare_liters: Math.round(rulePredictionPerHa)
                                },
                                difference_percent: parseFloat(window.diffPercent)
                            },
                            summary: {
                                total_water_needed: `${Math.round(totalWater).toLocaleString()} L`,
                                per_hectare: `${Math.round(mlPredictionPerHa).toLocaleString()} L/ha`,
                                field_size: `${fieldSize} ha`,
                                crop: cropType.charAt(0).toUpperCase() + cropType.slice(1),
                                location_short: locationName.split(',')[0]
                            }
                        })
                        .then(() => {
                            console.log("‚úÖ Prediction logged to Firebase:", sanitizedEmail);
                        })
                        .catch(e => {
                            console.error("‚ùå Firebase log error:", e);
                        });
                    }

                } else {
                    throw new Error(result.error || 'Prediction failed');
                }

            } catch (error) {
                console.error('Prediction Error:', error);
                alert(`Error: ${error.message}\n\nMake sure Flask server is running at ${FLASK_API_URL}`);
                
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ü§ñ Predict with ML';
            }
        }

        function predictWithRules(data) {
            const baseWater = 5000;
            const cropFactors = {
                'rice': 1.3, 'maize': 1.1, 'banana': 1.0, 'pomegranate': 0.9,
                'mango': 0.9, 'watermelon': 0.9, 'papaya': 1.0
            };
            const cropFactor = cropFactors[data.cropType] || 1.0;
            const moistureFactor = 1 - (data.soilMoisture / 200);
            const tempFactor = data.temperature > 30 ? 1.2 : 1.0;
            const humidityFactor = 1 - (data.humidity / 300);
            const rainfallReduction = data.rainfall * 100;
            let waterPerHa = baseWater * cropFactor * moistureFactor * tempFactor * humidityFactor;
            waterPerHa = Math.max(1000, waterPerHa - rainfallReduction);
            return Math.round(waterPerHa);
        }

        function generateRecommendations(data, mlPrediction, rulePrediction) {
            const recommendations = [];
            const avgPrediction = (mlPrediction + rulePrediction) / 2;
            const difference = Math.abs(mlPrediction - rulePrediction);
            window.diffPercent = ((difference / Math.max(1, avgPrediction)) * 100).toFixed(1);
            
            if (window.diffPercent > 25) {
                recommendations.push(`‚ö†Ô∏è ML and Rule-based models differ by ${window.diffPercent}%. Using ML prediction (trained on real data).`);
            } else {
                recommendations.push(`‚úÖ ML and Rule-based models agree (${window.diffPercent}% difference). High confidence in prediction.`);
            }
            
            if (data.soilMoisture > 70) {
                recommendations.push('üíß Soil moisture is high (>70%). Consider delaying irrigation.');
            } else if (data.soilMoisture < 30) {
                recommendations.push('üö® Critical: Soil moisture below 30%. Immediate irrigation required.');
            } else if (data.soilMoisture < 50) {
                recommendations.push('‚ö†Ô∏è Soil moisture moderate (30-50%). Plan irrigation soon.');
            } else {
                recommendations.push('‚úÖ Soil moisture optimal (50-70%).');
            }
            
            if (data.rainfall > 15) {
                recommendations.push('üåßÔ∏è Heavy rainfall detected (>15mm). Reduce or skip irrigation.');
            } else if (data.rainfall > 5) {
                recommendations.push('üå¶Ô∏è Light rain detected (>5mm). Consider reducing irrigation.');
            }
            
            return recommendations;
        }

        function checkAuth() {
            const userName = sessionStorage.getItem('userName') || localStorage.getItem('userName');
            const userEmail = sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail');
            if (!userName && !userEmail) {
                displayUserInfo("Guest User", "guest@example.com");
            } else {
                displayUserInfo(userName, userEmail);
            }
        }

        function displayUserInfo(name, email) {
            const userName = name || email || 'User';
            document.getElementById('userName').textContent = userName;
            document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
        }

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        function handleLogout() {
            console.log("Logout triggered.");
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>